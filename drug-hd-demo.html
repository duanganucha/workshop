<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>
            ขนาดยาด้านเชื้อจุลชีพที่แนะนำในผู้ป่วยวัยผู้ใหญ่ที่ไดวายเรื้อรัง
        </title>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
        <style>
            body {
                font-family: Arial, sans-serif;
                /* margin: 20px; */
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                min-height: 100vh;
                /* padding: 20px; */
            }

            .container {
                background: white;
                border-radius: 15px;
                padding: 30px;
                box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
                max-width: 1400px;
                margin: 0 auto;
            }

            h1 {
                color: #2c3e50;
                text-align: center;
                margin-bottom: 30px;
                font-size: 2.2em;
                text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
            }

            .url-info {
                background: linear-gradient(45deg, #e3f2fd, #bbdefb);
                border: 2px solid #2196f3;
                border-radius: 10px;
                padding: 15px;
                margin-bottom: 20px;
                font-size: 13px;
                color: #1976d2;
            }

            .url-info h3 {
                margin-top: 0;
                color: #1976d2;
            }

            .url-info code {
                background: rgba(255, 255, 255, 0.8);
                padding: 2px 6px;
                border-radius: 4px;
                font-family: monospace;
            }

            .export-btn {
                background: linear-gradient(45deg, #28a745, #20c997);
                color: white;
                border: none;
                padding: 15px 30px;
                font-size: 16px;
                border-radius: 25px;
                cursor: pointer;
                display: block;
                margin: 20px auto 30px auto;
                box-shadow: 0 8px 15px rgba(40, 167, 69, 0.3);
                transition: all 0.3s ease;
                font-weight: bold;
            }

            .export-btn:hover {
                transform: translateY(-2px);
                box-shadow: 0 12px 25px rgba(40, 167, 69, 0.4);
            }

            .export-btn:active {
                transform: translateY(0);
            }

            table {
                width: 100%;
                border-collapse: collapse;
                margin-top: 20px;
                background: white;
                border-radius: 10px;
                overflow: hidden;
                box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            }

            th {
                background: linear-gradient(45deg, #3498db, #2980b9);
                color: white;
                padding: 15px 10px;
                text-align: center;
                font-weight: bold;
                font-size: 14px;
            }

            td {
                padding: 12px 10px;
                border-bottom: 1px solid #ecf0f1;
                text-align: left;
                font-size: 13px;
                line-height: 1.4;
            }

            tr:nth-child(even) {
                background-color: #f8f9fa;
            }

            tr:hover {
                background-color: #e3f2fd;
                transition: background-color 0.3s ease;
            }

            .drug-name {
                font-weight: bold;
                color: #2c3e50;
            }

            .note {
                background: linear-gradient(45deg, #fff3cd, #ffeaa7);
                border: 1px solid #ffc107;
                border-radius: 8px;
                padding: 15px;
                margin: 20px 0;
                font-style: italic;
                color: #856404;
            }

            .footer {
                margin-top: 30px;
                text-align: center;
                color: #6c757d;
                font-size: 12px;
                border-top: 1px solid #dee2e6;
                padding-top: 20px;
            }

            .calculator-form {
                background: linear-gradient(135deg, #f8f9fa, #e9ecef);
                border: 2px solid #007bff;
                border-radius: 15px;
                padding: 25px;
                margin: 30px 0;
                box-shadow: 0 8px 20px rgba(0, 123, 255, 0.2);
            }

            .calculator-form h2 {
                color: #007bff;
                margin-bottom: 20px;
                text-align: center;
                font-size: 1.5em;
            }

            .form-row {
                display: flex;
                gap: 20px;
                margin-bottom: 20px;
                flex-wrap: wrap;
            }

            .form-group {
                flex: 1;
                min-width: 200px;
            }

            .form-group label {
                display: block;
                margin-bottom: 8px;
                font-weight: bold;
                color: #495057;
                font-size: 14px;
            }

            .form-group input,
            .form-group select {
                width: 100%;
                padding: 12px;
                border: 2px solid #ced4da;
                border-radius: 8px;
                font-size: 14px;
                transition: border-color 0.3s ease;
                box-sizing: border-box;
            }

            .form-group input:focus,
            .form-group select:focus {
                outline: none;
                border-color: #007bff;
                box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
            }

            .calc-btn {
                background: linear-gradient(45deg, #007bff, #0056b3);
                color: white;
                border: none;
                padding: 15px 40px;
                font-size: 16px;
                border-radius: 25px;
                cursor: pointer;
                display: block;
                margin: 25px auto;
                font-weight: bold;
                transition: all 0.3s ease;
                box-shadow: 0 4px 15px rgba(0, 123, 255, 0.3);
            }

            .calc-btn:hover {
                transform: translateY(-2px);
                box-shadow: 0 8px 20px rgba(0, 123, 255, 0.4);
            }

            .result-display {
                background: linear-gradient(45deg, #d4edda, #c3e6cb);
                border: 2px solid #28a745;
                border-radius: 10px;
                padding: 20px;
                margin-top: 20px;
                text-align: center;
                color: #155724;
                display: none;
                box-shadow: 0 4px 10px rgba(40, 167, 69, 0.2);
            }

            .result-display h3 {
                margin-top: 0;
                color: #155724;
                font-size: 1.3em;
            }

            .result-info {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 15px;
                margin: 15px 0;
                text-align: left;
            }

            .result-info p {
                margin: 5px 0;
                padding: 8px;
                background: rgba(255, 255, 255, 0.7);
                border-radius: 5px;
            }

            .dosing-result {
                background: linear-gradient(45deg, #fff3cd, #ffeaa7);
                border: 2px solid #ffc107;
                border-radius: 8px;
                padding: 12px;
                margin: 5px 0;
                color: #856404;
                font-weight: bold;
                box-shadow: 0 2px 5px rgba(255, 193, 7, 0.2);
            }

            .calculated-dose {
                background: linear-gradient(45deg, #d1ecf1, #bee5eb);
                border: 2px solid #17a2b8;
                border-radius: 8px;
                padding: 12px;
                margin: 5px 0;
                color: #0c5460;
                font-weight: bold;
            }

            .warning-box {
                background: linear-gradient(45deg, #f8d7da, #f5c6cb);
                border: 2px solid #dc3545;
                border-radius: 8px;
                padding: 10px;
                margin: 5px 0;
                color: #721c24;
                font-size: 12px;
            }

            .clear-btn {
                background: linear-gradient(45deg, #6c757d, #5a6268);
                color: white;
                border: none;
                padding: 10px 25px;
                font-size: 14px;
                border-radius: 20px;
                cursor: pointer;
                margin-left: 10px;
                transition: all 0.3s ease;
            }

            .clear-btn:hover {
                transform: translateY(-1px);
                box-shadow: 0 4px 10px rgba(108, 117, 125, 0.3);
            }

            .input-group {
                display: flex;
                align-items: center;
                gap: 10px;
            }

            .unit-label {
                font-size: 12px;
                color: #6c757d;
                font-weight: normal;
            }

            .prefilled-indicator {
                color: #28a745;
                font-size: 12px;
                margin-left: 5px;
            }

            @media (max-width: 768px) {
                .form-row {
                    flex-direction: column;
                }

                .result-info {
                    grid-template-columns: 1fr;
                }

                .container {
                    padding: 15px;
                    margin: 10px;
                }
            }
        </style>
    </head>
    <body>
        <div class="container">
            <h3>
                📊
                คำนวณขนาดยาด้านเชื้อจุลชีพที่แนะนำในผู้ป่วยวัยผู้ใหญ่ที่ไดวายเรื้อรัง
            </h3>

            <!-- <div class="url-info">
                <h3>📎 URL Parameters (พารามิเตอร์ URL)</h3>
                <p>
                    <strong>วิธีใช้:</strong> คุณสามารถส่งค่าเริ่มต้นผ่าน URL
                    ได้โดยใช้พารามิเตอร์เหล่านี้:
                </p>
                <ul>
                    <li><code>age</code> = อายุ (ปี)</li>
                    <li><code>weight</code> = น้ำหนัก (kg)</li>
                    <li><code>creatinine</code> = ค่าครีเอตินีน (mg/dL)</li>
                    <li><code>gender</code> = เพศ (male หรือ female)</li>
                    <li><code>dialysis</code> = สถานะฟอกไต (yes หรือ no)</li>
                    <li><code>indication</code> = ข้อบ่งใช้</li>
                </ul>
                <p>
                    <strong>ตัวอย่าง:</strong>
                    <code
                        >?age=65&weight=70&creatinine=1.5&gender=male&dialysis=no&indication=UTI</code
                    >
                </p>
            </div> -->

            <div class="calculator-form">
                <!-- <h2>🧮 Patient Dosing Calculator</h2> -->
                <form id="dosingForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label>Patient Age (อายุผู้ป่วย):</label>
                            <div class="input-group">
                                <input
                                    type="number"
                                    id="age"
                                    min="1"
                                    max="120"
                                    placeholder="ระบุอายุ"
                                    required
                                />
                                <span class="unit-label">ปี / years</span>
                                <!-- <span
                                    id="age-indicator"
                                    class="prefilled-indicator"
                                    style="display: none"
                                    >✓ จาก URL</span
                                > -->
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Body Weight (น้ำหนักตัว):</label>
                            <div class="input-group">
                                <input
                                    type="number"
                                    id="weight"
                                    min="1"
                                    max="300"
                                    step="0.1"
                                    placeholder="ระบุน้ำหนัก"
                                    required
                                />
                                <span class="unit-label">kg</span>
                                <!-- <span
                                    id="weight-indicator"
                                    class="prefilled-indicator"
                                    style="display: none"
                                    >✓ จาก URL</span
                                > -->
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Serum Creatinine (ค่าครีเอตินีน):</label>
                            <div class="input-group">
                                <input
                                    type="number"
                                    id="creatinine"
                                    min="0.1"
                                    max="20"
                                    step="0.1"
                                    placeholder="ระบุค่าครีเอตินีน"
                                    required
                                />
                                <span class="unit-label">mg/dL</span>
                                <!-- <span
                                    id="creatinine-indicator"
                                    class="prefilled-indicator"
                                    style="display: none"
                                    >✓ จาก URL</span
                                > -->
                            </div>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Gender (เพศ):</label>
                            <div class="input-group">
                                <select id="gender" required>
                                    <option value="">
                                        เลือกเพศ / Select gender
                                    </option>
                                    <option value="male">Male (ชาย)</option>
                                    <option value="female">
                                        Female (หญิง)
                                    </option>
                                </select>
                                <!-- <span
                                    id="gender-indicator"
                                    class="prefilled-indicator"
                                    style="display: none"
                                    >✓ จาก URL</span
                                > -->
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Hemodialysis Status (สถานะฟอกไต):</label>
                            <div class="input-group">
                                <select id="dialysis">
                                    <option value="no">
                                        No dialysis (ไม่ฟอกไต)
                                    </option>
                                    <option value="yes">
                                        On hemodialysis (ฟอกไต)
                                    </option>
                                </select>
                                <!-- <span
                                    id="dialysis-indicator"
                                    class="prefilled-indicator"
                                    style="display: none"
                                    >✓ จาก URL</span
                                > -->
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Indication (ข้อบ่งใช้):</label>
                            <div class="input-group">
                                <input
                                    type="text"
                                    id="indication"
                                    placeholder="เช่น UTI, Pneumonia (ไม่บังคับ)"
                                />
                                <!-- <span
                                    id="indication-indicator"
                                    class="prefilled-indicator"
                                    style="display: none"
                                    >✓ จาก URL</span
                                > -->
                            </div>
                        </div>
                    </div>
                    <div style="text-align: center">
                        <button
                            type="button"
                            class="calc-btn"
                            onclick="calculateDosing()"
                        >
                            🔍 Calculate Dosing (คำนวณขนาดยา)
                        </button>
                        <button
                            type="button"
                            class="clear-btn"
                            onclick="clearForm()"
                        >
                            🗑️ Clear (ล้างข้อมูล)
                        </button>
                    </div>
                </form>

                <div id="crclResult" class="result-display"></div>
            </div>

            <table id="dosingTable">
                <thead>
                    <tr>
                        <th style="width: 20%">
                            Drug Name<br />(ชื่อยาต้านจุลชีพ)
                        </th>
                        <th style="width: 20%">CrCL 10-50 mL/min</th>
                        <th style="width: 20%">CrCL < 10 mL/min</th>
                        <th style="width: 20%">Hemodialysis<br />(ฟอกไต)</th>
                        <th style="width: 20%">
                            Calculated Dose<br />(ขนาดยาที่คำนวณได้)
                        </th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td class="drug-name">Acyclovir inj. 500 mg</td>
                        <td>5-12.5 mg/kg q 12-24 hr</td>
                        <td>2.5-6.25 mg/kg q 24 hr</td>
                        <td>2.5-6.25 mg/kg q24h (dialysis day give AD)</td>
                        <td
                            class="dosing-column"
                            data-drug="acyclovir-inj"
                        ></td>
                    </tr>
                    <tr>
                        <td class="drug-name">Ampicillin inj. 500 mg</td>
                        <td>
                            CrCl 30-50: 1-2 gm q 6-8 hr<br />CrCl 10-30: 1-2 gm
                            q 8-12 hr
                        </td>
                        <td>1-2 gm q 12 hr</td>
                        <td>1-2 gm q 12 hr (dialysis day give AD)</td>
                        <td
                            class="dosing-column"
                            data-drug="ampicillin-500"
                        ></td>
                    </tr>
                    <tr>
                        <td class="drug-name">Ampicillin inj. 1000 mg</td>
                        <td>
                            CrCl 30-50: 1-2 gm q 6-8 hr<br />CrCl 10-30: 1-2 gm
                            q 8-12 hr
                        </td>
                        <td>1-2 gm q 12 hr</td>
                        <td>1-2 gm q 12 hr (dialysis day give AD)</td>
                        <td
                            class="dosing-column"
                            data-drug="ampicillin-1000"
                        ></td>
                    </tr>
                    <tr>
                        <td class="drug-name">Amikacin 500 mg</td>
                        <td>7.5 mg/kg q 24 hr</td>
                        <td>7.5 mg/kg q 48 hr</td>
                        <td>7.5 mg/kg q 48 hr (+extra 3.75 mg/kg AD)</td>
                        <td class="dosing-column" data-drug="amikacin"></td>
                    </tr>
                    <tr>
                        <td class="drug-name">Augmentin inj. 1.2 gm</td>
                        <td>1.2 gm initial dose then 0.6 gm q 12 h</td>
                        <td>1.2 gm initial dose then 0.6 gm IV q 24 hr</td>
                        <td>
                            1.2 gm initial dose then 0.6 gm IV q 24 hr (dialysis
                            day give AD)
                        </td>
                        <td
                            class="dosing-column"
                            data-drug="augmentin-inj"
                        ></td>
                    </tr>
                    <tr>
                        <td class="drug-name">Fortum® inj. 2g (ceftazidime)</td>
                        <td>2 gm IV q 12-24 hr</td>
                        <td>2 gm IV q 24-48 hr</td>
                        <td>2 gm IV q 24-48 hr (+extra 1 gm AD)</td>
                        <td class="dosing-column" data-drug="fortum"></td>
                    </tr>
                 
                </tbody>
            </table>

            <button class="export-btn" onclick="exportToExcel()">
                📥 Export to Excel (ส่งออกเป็น Excel)
            </button>

            <div class="footer">
                <!-- <p>
                    <strong>Reference:</strong> Adapted from standard
                    antimicrobial dosing guidelines
                </p>
                <p>
                    <em
                        >AD = after dialysis | คำนวณตาม Cockcroft-Gault
                        formula</em
                    >
                </p> -->
                <p>
                    <em
                        >⚠️ ข้อมูลนี้เป็นแนวทางเบื้องต้น
                        ควรปรึกษาแพทย์ก่อนใช้ยา</em
                    >
                </p>
            </div>
        </div>

        <script>
            let currentCrCL = 0;
            let isDialysis = false;
            let patientWeight = 0;
            let patientAge = 0;
            let patientGender = "";

            // Function to get URL parameters
            function getURLParameters() {
                const urlParams = new URLSearchParams(window.location.search);
                const params = {};

                // Get all possible parameters
                const paramNames = [
                    "age",
                    "weight",
                    "creatinine",
                    "gender",
                    "dialysis",
                    "indication",
                ];

                paramNames.forEach((param) => {
                    if (urlParams.has(param)) {
                        params[param] = urlParams.get(param);
                    }
                });

                return params;
            }

            // Function to populate form with URL parameters
            function populateFormFromURL() {
                const params = getURLParameters();
                let hasParams = false;

                // Populate each field if parameter exists
                Object.keys(params).forEach((key) => {
                    const element = document.getElementById(key);
                    const indicator = document.getElementById(
                        key + "-indicator"
                    );

                    if (element && params[key]) {
                        if (key === "gender" || key === "dialysis") {
                            // For select elements, make sure the value exists
                            const option = element.querySelector(
                                `option[value="${params[key]}"]`
                            );
                            if (option) {
                                element.value = params[key];
                                if (indicator)
                                    indicator.style.display = "inline";
                                hasParams = true;
                            }
                        } else {
                            // For input elements
                            element.value = params[key];
                            if (indicator) indicator.style.display = "inline";
                            hasParams = true;
                        }
                    }
                });

                // If parameters were loaded, show a notification and auto-calculate
                if (hasParams) {
                    showURLLoadNotification();
                    // Auto-calculate if we have required fields
                    const age = document.getElementById("age").value;
                    const weight = document.getElementById("weight").value;
                    const creatinine =
                        document.getElementById("creatinine").value;
                    const gender = document.getElementById("gender").value;

                    if (age && weight && creatinine && gender) {
                        setTimeout(() => {
                            calculateDosing();
                        }, 1000); // Delay to show the notification first
                    }
                }
            }

            // Function to show URL parameter load notification
            function showURLLoadNotification() {
                const notification = document.createElement("div");
                notification.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background: linear-gradient(45deg, #28a745, #20c997);
                    color: white;
                    padding: 15px 20px;
                    border-radius: 10px;
                    box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);
                    z-index: 1000;
                    font-weight: bold;
                    animation: slideIn 0.5s ease-out;
                `;
                notification.innerHTML = "✅ ข้อมูลจาก URL ถูกโหลดแล้ว!";

                // Add animation keyframes
                if (!document.getElementById("notification-styles")) {
                    const style = document.createElement("style");
                    style.id = "notification-styles";
                    style.textContent = `
                        @keyframes slideIn {
                            from { transform: translateX(100%); opacity: 0; }
                            to { transform: translateX(0); opacity: 1; }
                        }
                        @keyframes slideOut {
                            from { transform: translateX(0); opacity: 1; }
                            to { transform: translateX(100%); opacity: 0; }
                        }
                    `;
                    document.head.appendChild(style);
                }

                document.body.appendChild(notification);

                // Remove notification after 3 seconds
                setTimeout(() => {
                    notification.style.animation = "slideOut 0.5s ease-out";
                    setTimeout(() => {
                        if (notification.parentNode) {
                            notification.parentNode.removeChild(notification);
                        }
                    }, 500);
                }, 3000);
            }

            // Function to generate shareable URL
            function generateShareableURL() {
                const age = document.getElementById("age").value;
                const weight = document.getElementById("weight").value;
                const creatinine = document.getElementById("creatinine").value;
                const gender = document.getElementById("gender").value;
                const dialysis = document.getElementById("dialysis").value;
                const indication = document.getElementById("indication").value;

                const params = new URLSearchParams();

                if (age) params.set("age", age);
                if (weight) params.set("weight", weight);
                if (creatinine) params.set("creatinine", creatinine);
                if (gender) params.set("gender", gender);
                if (dialysis && dialysis !== "no")
                    params.set("dialysis", dialysis);
                if (indication) params.set("indication", indication);

                const baseURL =
                    window.location.origin + window.location.pathname;
                const shareableURL = baseURL + "?" + params.toString();

                return shareableURL;
            }

            // Function to copy shareable URL to clipboard
            function copyShareableURL() {
                const url = generateShareableURL();

                if (navigator.clipboard) {
                    navigator.clipboard
                        .writeText(url)
                        .then(() => {
                            showCopyNotification("URL copied to clipboard!");
                        })
                        .catch(() => {
                            fallbackCopyTextToClipboard(url);
                        });
                } else {
                    fallbackCopyTextToClipboard(url);
                }
            }

            // Fallback copy function for older browsers
            function fallbackCopyTextToClipboard(text) {
                const textArea = document.createElement("textarea");
                textArea.value = text;
                textArea.style.position = "fixed";
                textArea.style.left = "-999999px";
                textArea.style.top = "-999999px";
                document.body.appendChild(textArea);
                textArea.focus();
                textArea.select();

                try {
                    document.execCommand("copy");
                    showCopyNotification("URL copied to clipboard!");
                } catch (err) {
                    showCopyNotification("Failed to copy URL");
                }

                document.body.removeChild(textArea);
            }

            // Function to show copy notification
            function showCopyNotification(message) {
                const notification = document.createElement("div");
                notification.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background: linear-gradient(45deg, #007bff, #0056b3);
                    color: white;
                    padding: 15px 20px;
                    border-radius: 10px;
                    box-shadow: 0 4px 15px rgba(0, 123, 255, 0.3);
                    z-index: 1000;
                    font-weight: bold;
                    animation: slideIn 0.5s ease-out;
                `;
                notification.innerHTML = "📋 " + message;

                document.body.appendChild(notification);

                setTimeout(() => {
                    notification.style.animation = "slideOut 0.5s ease-out";
                    setTimeout(() => {
                        if (notification.parentNode) {
                            notification.parentNode.removeChild(notification);
                        }
                    }, 500);
                }, 2000);
            }

            function calculateCrCL(age, weight, creatinine, gender) {
                // Cockcroft-Gault formula: CrCL = (140 - age) × weight / (72 × serum creatinine)
                // For females, multiply by 0.85
                let crcl = ((140 - age) * weight) / (72 * creatinine);
                if (gender === "female") {
                    crcl *= 0.85;
                }
                return Math.round(crcl * 100) / 100; // Round to 2 decimal places
            }

            function calculateDosing() {
                const age = parseInt(document.getElementById("age").value);
                const weight = parseFloat(
                    document.getElementById("weight").value
                );
                const creatinine = parseFloat(
                    document.getElementById("creatinine").value
                );
                const gender = document.getElementById("gender").value;
                const dialysis = document.getElementById("dialysis").value;
                const indication =
                    document.getElementById("indication").value ||
                    "General infection";

                if (!age || !weight || !creatinine || !gender) {
                    alert(
                        "กรุณากรอกข้อมูลให้ครบทุกช่องที่จำเป็น / Please fill in all required fields"
                    );
                    return;
                }

                // Validation
                if (age < 1 || age > 120) {
                    alert(
                        "อายุต้องอยู่ระหว่าง 1-120 ปี / Age must be between 1-120 years"
                    );
                    return;
                }

                if (weight < 1 || weight > 300) {
                    alert(
                        "น้ำหนักต้องอยู่ระหว่าง 1-300 กิโลกรัม / Weight must be between 1-300 kg"
                    );
                    return;
                }

                if (creatinine < 0.1 || creatinine > 20) {
                    alert(
                        "ค่าครีเอตินีนต้องอยู่ระหว่าง 0.1-20 mg/dL / Creatinine must be between 0.1-20 mg/dL"
                    );
                    return;
                }

                // Store global variables
                patientWeight = weight;
                patientAge = age;
                patientGender = gender;
                isDialysis = dialysis === "yes";

                if (isDialysis) {
                    currentCrCL = 0; // For dialysis patients, CrCL is irrelevant
                } else {
                    currentCrCL = calculateCrCL(
                        age,
                        weight,
                        creatinine,
                        gender
                    );
                }

                // Display results
                const resultDiv = document.getElementById("crclResult");
                let resultHTML = `<h3>📋 ผลการคำนวณ / Calculation Results</h3>`;

                resultHTML += `<div class="result-info">`;
                resultHTML += `<p><strong>ผู้ป่วย:</strong> ${
                    gender === "male" ? "ชาย" : "หญิง"
                }, อายุ ${age} ปี</p>`;
                resultHTML += `<p><strong>น้ำหนัก:</strong> ${weight} kg</p>`;
                resultHTML += `<p><strong>Serum Creatinine:</strong> ${creatinine} mg/dL</p>`;
                resultHTML += `<p><strong>ข้อบ่งใช้:</strong> ${indication}</p>`;

                if (isDialysis) {
                    resultHTML += `<p><strong>สถานะ:</strong> 🏥 ผู้ป่วยฟอกไต</p>`;
                    resultHTML += `<p><strong>หมวดหมู่การให้ยา:</strong> ใช้คอลัมน์ Hemodialysis</p>`;
                } else {
                    resultHTML += `<p><strong>CrCL (คำนวณ):</strong> ${currentCrCL} mL/min</p>`;
                    if (currentCrCL >= 10 && currentCrCL <= 50) {
                        resultHTML += `<p><strong>หมวดหมู่:</strong> 🟡 CrCL 10-50 mL/min (ไตเสื่อมปานกลาง)</p>`;
                    } else if (currentCrCL < 10) {
                        resultHTML += `<p><strong>หมวดหมู่:</strong> 🔴 CrCL < 10 mL/min (ไตเสื่อมรุนแรง)</p>`;
                    } else {
                        resultHTML += `<p><strong>หมวดหมู่:</strong> 🟢 ไตทำงานปกติ (CrCL > 50)</p>`;
                        resultHTML += `<p><em>หมายเหตุ: ตารางนี้สำหรับผู้ป่วยที่มีการทำงานของไตลดลง</em></p>`;
                    }
                }

                // Add share button
                // resultHTML += `<p style="text-align: center; margin-top: 15px;">
                //     <button onclick="copyShareableURL()" style="
                //         background: linear-gradient(45deg, #17a2b8, #138496);
                //         color: white;
                //         border: none;
                //         padding: 8px 16px;
                //         border-radius: 15px;
                //         cursor: pointer;
                //         font-size: 12px;
                //         transition: all 0.3s ease;
                //     ">
                //         🔗 Copy Shareable URL
                //     </button>
                // </p>`;

                resultHTML += `</div>`;

                // Add warning for elderly patients
                if (age >= 65) {
                    resultHTML += `<div class="warning-box">⚠️ ผู้ป่วยสูงอายุ: ควรพิจารณาลดขนาดยาและติดตามอาการข้างเคียงอย่างใกล้ชิด</div>`;
                }

                resultDiv.innerHTML = resultHTML;
                resultDiv.style.display = "block";

                // Update dosing recommendations in table
                updateDosingRecommendations();
            }

            function calculateSpecificDose(doseString, weight) {
                // Helper function to calculate mg/kg doses
                if (doseString.includes("mg/kg")) {
                    const matches = doseString.match(
                        /(\d+(?:\.\d+)?(?:-\d+(?:\.\d+)?)?)\s*mg\/kg/g
                    );
                    if (matches) {
                        let calculations = [];
                        matches.forEach((match) => {
                            const doseMatch = match.match(
                                /(\d+(?:\.\d+)?(?:-\d+(?:\.\d+)?)?)/
                            );
                            if (doseMatch) {
                                const doseRange = doseMatch[1];
                                if (doseRange.includes("-")) {
                                    const [min, max] = doseRange
                                        .split("-")
                                        .map(Number);
                                    const minDose =
                                        Math.round(min * weight * 10) / 10;
                                    const maxDose =
                                        Math.round(max * weight * 10) / 10;
                                    calculations.push(
                                        `${minDose}-${maxDose} mg`
                                    );
                                } else {
                                    const dose =
                                        Math.round(
                                            Number(doseRange) * weight * 10
                                        ) / 10;
                                    calculations.push(`${dose} mg`);
                                }
                            }
                        });
                        return calculations.length > 0
                            ? calculations.join(" หรือ ")
                            : null;
                    }
                }
                return null;
            }

            function updateDosingRecommendations() {
                const dosingColumns =
                    document.querySelectorAll(".dosing-column");

                dosingColumns.forEach((column) => {
                    const row = column.parentElement;
                    const cells = row.cells;

                    // Check if we have enough cells to read from
                    if (cells.length < 4) return;

                    const drugName = cells[0].textContent;
                    let recommendedDose = "";
                    let calculatedDose = "";
                    let sourceColumn = "";

                    // Determine which column to use based on patient status
                    if (isDialysis) {
                        recommendedDose =
                            cells[3] && cells[3].textContent.trim()
                                ? cells[3].textContent
                                : "ไม่มีข้อมูลขนาดยาสำหรับผู้ป่วยฟอกไต";
                        sourceColumn = "Hemodialysis";
                    } else if (currentCrCL >= 10 && currentCrCL <= 50) {
                        recommendedDose =
                            cells[1] && cells[1].textContent.trim()
                                ? cells[1].textContent
                                : "ไม่มีข้อมูลขนาดยาสำหรับช่วง CrCL นี้";
                        sourceColumn = "CrCL 10-50";
                    } else if (currentCrCL < 10) {
                        recommendedDose =
                            cells[2] && cells[2].textContent.trim()
                                ? cells[2].textContent
                                : "ไม่มีข้อมูลขนาดยาสำหรับไตเสื่อมรุนแรง";
                        sourceColumn = "CrCL < 10";
                    } else {
                        recommendedDose = "ใช้ขนาดยาปกติตามแนวทางมาตรฐาน";
                        sourceColumn = "Normal kidney function";
                    }

                    // Handle special cases for empty cells
                    if (!recommendedDose || recommendedDose.trim() === "") {
                        if (drugName.includes("Gabapentin")) {
                            if (currentCrCL >= 15) {
                                recommendedDose = "ใช้ขนาดยามาตรฐาน (CrCL ≥15)";
                            } else {
                                recommendedDose = "100-300 mg q 24 hr";
                            }
                        } else if (
                            drugName.includes("Ampicillin inj. 1000 mg")
                        ) {
                            recommendedDose =
                                "ใช้แนวทางเดียวกับ Ampicillin 500 mg";
                        } else {
                            recommendedDose =
                                "ดูข้อมูลการสั่งยาหรือปรึกษาเภสัชกร";
                        }
                    }

                    // Calculate specific doses for mg/kg drugs
                    if (
                        patientWeight > 0 &&
                        recommendedDose.includes("mg/kg")
                    ) {
                        calculatedDose = calculateSpecificDose(
                            recommendedDose,
                            patientWeight
                        );
                    }

                    // Create comprehensive result display
                    let resultHTML = `<div class="calculated-dose">`;
                    resultHTML += `<strong>แนวทาง (${sourceColumn}):</strong><br>`;
                    resultHTML += `${recommendedDose}`;

                    if (calculatedDose) {
                        resultHTML += `<br><br><strong>ขนาดยาคำนวณสำหรับผู้ป่วยน้ำหนัก ${patientWeight} kg:</strong><br>`;
                        resultHTML += `<span style="color: #0c5460; font-size: 16px;">${calculatedDose}</span>`;
                    }

                    // Add timing information based on the recommended dose
                    if (recommendedDose.includes("q 6")) {
                        resultHTML += `<br><small>📅 ให้ทุก 6 ชั่วโมง (4 ครั้ง/วัน)</small>`;
                    } else if (recommendedDose.includes("q 8")) {
                        resultHTML += `<br><small>📅 ให้ทุก 8 ชั่วโมง (3 ครั้ง/วัน)</small>`;
                    } else if (recommendedDose.includes("q 12")) {
                        resultHTML += `<br><small>📅 ให้ทุก 12 ชั่วโมง (2 ครั้ง/วัน)</small>`;
                    } else if (recommendedDose.includes("q 24")) {
                        resultHTML += `<br><small>📅 ให้ทุก 24 ชั่วโมง (1 ครั้ง/วัน)</small>`;
                    } else if (recommendedDose.includes("q 48")) {
                        resultHTML += `<br><small>📅 ให้ทุก 48 ชั่วโมง (วันเว้นวัน)</small>`;
                    }

                    // Add special warnings
                    if (recommendedDose.includes("AD") && isDialysis) {
                        resultHTML += `<br><div class="warning-box">💉 ให้ยาเพิ่มหลังฟอกไต (After Dialysis)</div>`;
                    }

                    if (recommendedDose.includes("Not recommend")) {
                        resultHTML += `<br><div class="warning-box">⚠️ ไม่แนะนำให้ใช้ยานี้ในผู้ป่วยกลุมนี้</div>`;
                    }

                    resultHTML += `</div>`;

                    column.innerHTML = resultHTML;
                });
            }

            function clearForm() {
                document.getElementById("age").value = "";
                document.getElementById("weight").value = "";
                document.getElementById("creatinine").value = "";
                document.getElementById("gender").value = "";
                document.getElementById("dialysis").value = "no";
                document.getElementById("indication").value = "";

                // Hide all indicators
                const indicators = document.querySelectorAll(
                    ".prefilled-indicator"
                );
                indicators.forEach((indicator) => {
                    indicator.style.display = "none";
                });

                document.getElementById("crclResult").style.display = "none";

                // Clear all dosing recommendations
                const dosingColumns =
                    document.querySelectorAll(".dosing-column");
                dosingColumns.forEach((column) => {
                    column.innerHTML =
                        '<div style="text-align: center; color: #6c757d; font-style: italic;">กรุณาคำนวณขนาดยา</div>';
                });

                // Reset global variables
                currentCrCL = 0;
                isDialysis = false;
                patientWeight = 0;
                patientAge = 0;
                patientGender = "";

                // Clear URL parameters
                if (window.history.replaceState) {
                    window.history.replaceState(
                        {},
                        document.title,
                        window.location.pathname
                    );
                }
            }

            function exportToExcel() {
                // Get the table
                const table = document.getElementById("dosingTable");

                // Clone the table to avoid modifying the original
                const tableClone = table.cloneNode(true);

                // Add patient information as header rows if calculation has been done
                if (patientWeight > 0) {
                    const headerRow1 = tableClone.insertRow(0);
                    headerRow1.insertCell(
                        0
                    ).innerHTML = `Patient Information: ${
                        patientGender === "male" ? "Male" : "Female"
                    }, Age ${patientAge} years, Weight ${patientWeight} kg`;
                    headerRow1.cells[0].colSpan = 5;

                    const headerRow2 = tableClone.insertRow(1);
                    if (isDialysis) {
                        headerRow2.insertCell(
                            0
                        ).innerHTML = `Status: Hemodialysis Patient`;
                    } else {
                        headerRow2.insertCell(
                            0
                        ).innerHTML = `Calculated CrCL: ${currentCrCL} mL/min`;
                    }
                    headerRow2.cells[0].colSpan = 5;

                    const spacerRow = tableClone.insertRow(2);
                    spacerRow.insertCell(0).innerHTML = "";
                    spacerRow.cells[0].colSpan = 5;
                }

                // Create a workbook
                const wb = XLSX.utils.book_new();

                // Convert table to worksheet
                const ws = XLSX.utils.table_to_sheet(tableClone);

                // Set column widths
                ws["!cols"] = [
                    { wch: 25 }, // Drug name
                    { wch: 25 }, // CrCL 10-50
                    { wch: 25 }, // CrCL < 10
                    { wch: 25 }, // Hemodialysis
                    { wch: 30 }, // Calculated dose
                ];

                // Add the worksheet to the workbook
                XLSX.utils.book_append_sheet(
                    wb,
                    ws,
                    "Medical Dosing Guidelines"
                );

                // Generate filename with timestamp
                const now = new Date();
                const timestamp = now.toISOString().slice(0, 10);
                const filename = `Medical_Dosing_Guidelines_${timestamp}.xlsx`;

                // Save the file
                XLSX.writeFile(wb, filename);
            }

            // Initialize the form
            document.addEventListener("DOMContentLoaded", function () {
                // Load URL parameters first
                populateFormFromURL();

                // If no URL parameters, clear form
                const urlParams = new URLSearchParams(window.location.search);
                if (!urlParams.toString()) {
                    clearForm();
                }

                // Add form validation
                const form = document.getElementById("dosingForm");
                const inputs = form.querySelectorAll(
                    "input[required], select[required]"
                );

                inputs.forEach((input) => {
                    input.addEventListener("blur", function () {
                        if (!this.value) {
                            this.style.borderColor = "#dc3545";
                        } else {
                            this.style.borderColor = "#28a745";
                        }
                    });

                    input.addEventListener("input", function () {
                        if (this.value) {
                            this.style.borderColor = "#ced4da";
                        }
                    });
                });
            });

            // Add keyboard shortcuts
            document.addEventListener("keydown", function (e) {
                if (e.ctrlKey && e.key === "Enter") {
                    calculateDosing();
                }
                if (e.ctrlKey && e.key === "Delete") {
                    clearForm();
                }
                if (e.ctrlKey && e.key === "u") {
                    e.preventDefault();
                    copyShareableURL();
                }
            });
        </script>
    </body>
</html>
